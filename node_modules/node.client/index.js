var fs = require('fs'),
	url = require('url'),
	path = require('path'),
	sys = require('sys');

MODULE_NAME = 'Node.client';

var log = function(msg) {
	sys.puts(MODULE_NAME + ': '+msg)
}

var response_from_file = function(response,path_,content_type) {
	
	var body = fs.readFileSync(path_);
	
	headers = {'Content-Length':body.length}
	
	if (!content_type) {
		if (path_.substr(-3) === '.js')
			content_type = 'application/javascript';
		else if (path_.substr(-4) === '.html')
			content_type = 'text/html';
	}
	
	if (content_type) {
		headers['Content-Type'] = content_type
	}
	
	log('Sending file "' + path_ + '".')
	
	response.writeHead(200, headers)
	response.write(body)
	response.end()
}


var error_404 = function(response,message) {
	if (!message) message = ''
	
	var body = "<h1>404 Error</h1>\n<p>"+message+"</p>";
	response.writeHead(404, {
		'Content-Length':body.length,
		'Content-Type':'text/html'})

	response.write(body)
	response.end()
}



this.listen = function(httpServer) {
	
	httpServer.on('request', function(request,response) {
		
		urlpath = url.parse(request.url).pathname
		
		
		if (urlpath.indexOf('/node.client/') == 0) {
			log('Handling: "'+request.url+'"')
			
			newpath = './node_modules' + urlpath
			log('Try to get file ' + newpath)
			try {
				response_from_file(response,newpath)
			} catch(e) {
				log(e);
				newpath = './node_modules/' + urlpath.substr('/node.client/'.length)
				log('Try to get file ' + newpath)
				try {
					response_from_file(response,newpath)	
				} catch(e) {
					log(e);
					dirpath = path.dirname(newpath)
					basename = path.basename(newpath,'.js')
					newpath = path.join('.',dirpath,basename,'index.js')
					log('Try to get file ' + newpath)
					try {
						response_from_file(response,newpath)
					} catch (e) {
						log(e)
						error_404(response,"Can't find file.")
					}
					
					
				}

			}
		} 
	});
	log('Listening for "./node.client/" files...')
};